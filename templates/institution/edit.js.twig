<script>
    var $newPlaceDiv = $('#newInstitutionPlace');
    var $placeSelect = $('#institution_place');
    var $newPlaceCheckbox = $('#institution_new_place_toggle_0');
    var valueSelected = $placeSelect.find("option:selected").val();
    if($placeSelect.val()){
    toggleCheckboxActivation($newPlaceCheckbox, $placeSelect);
    toggleFormActivation($newPlaceDiv, $placeSelect, $(this));
}

    $placeSelect.on('change', function (e) {
    toggleCheckboxActivation($newPlaceCheckbox, $placeSelect);
    toggleFormActivation($newPlaceDiv, $placeSelect, $(this));
    $('#edit_place_marker').remove();

    if($placeSelect.val()) {
    var geojson = (function () {
    var json = null;
    var url = Routing.generate('place_geojson_view', {place_id: $placeSelect.val()});
    console.log(url);
    $.ajax({
    'async': false,
    'global': false,
    'url': url,
    'dataType': "json",
    'success': function (data) {
    json = data;
}
});
    return json;
})();

    console.log(geojson);

    geojson[0].features.forEach(function (marker) {
    var el = document.createElement('div');
    el.className = 'marker selected';
    el.id = 'edit_place_marker';
    var marker = new mapboxgl.Marker(el)
    .setLngLat(marker.geometry.coordinates)
    .addTo(map);

});
}
});


    mapboxgl.accessToken = 'pk.eyJ1IjoiamFjb2JvcnJqZSIsImEiOiJjanFtOWtwbmg2a2YwNDNwcGg2cG1sZzN1In0.c11tDOxEs5T5YHgbO0TAKg';
    var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/jacoborrje/cjslfs6640gc61gk4nrw1hagf',
    center: [0,60],
    zoom: 3
});
    deactivateForm($newPlaceDiv);

    if(!valueSelected) {
}
    else{
    deactivateForm($newPlaceDiv);
    var el = document.createElement('div');
    el.className = 'marker selected';
    el.id = 'edit_place_marker';
    var marker = new mapboxgl.Marker(el)
    .setLngLat([{{ institution.place.lng }},{{ institution.place.lat }}])
    .addTo(map);
}

    $newPlaceCheckbox.on('change', function (e) {
    toggleFormActivation($newPlaceDiv, $placeSelect, $(this));
    if($newPlaceCheckbox.prop('checked')){
    map.on('click', addDraggableMarker);
}
    else{
    removeDraggableMarker(map);
}
});


    function mapClick(e){
    $('#institution_new_place_lng').val(e.lngLat.lng);
    $('#institution_new_place_lat').val(e.lngLat.lat);
    if ($('#new_place_marker'))
    $('#new_place_marker').remove();

    var el = document.createElement('div');
    el.className = 'marker selected';
    el.id = 'new_place_marker';

    var marker = new mapboxgl.Marker(el)
    .setLngLat(e.lngLat)
    .setDraggable(true);

    marker.on('drag', function () {
    $('#institution_new_place_lng').val(marker.getLngLat().lng);
    $('#institution_new_place_lat').val(marker.getLngLat().lat);
});
    marker.addTo(map);
}
</script>